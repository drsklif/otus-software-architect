# Домашнее задание №3
## Тема: Prometheus. Grafana

**Задание:**
* Инструментировать сервис из прошлого задания метриками в формате Prometheus с помощью библиотеки для вашего фреймворка и ЯП.
* Сделать дашборд в Графане, в котором были бы метрики с разбивкой по API методам:
1. Latency (response time) с квантилями по 0.5, 0.95, 0.99, max
2. RPS
3. Error Rate - количество 500ых ответов
* Добавить в дашборд графики с метрикам в целом по сервису, взятые с nginx-ingress-controller:
1. Latency (response time) с квантилями по 0.5, 0.95, 0.99, max
2. RPS
3. Error Rate - количество 500ых ответов
* Настроить алертинг в графане на Error Rate и Latency.

**На выходе должно быть:**
1. скриншоты дашборды с графиками в момент стресс-тестирования сервиса. Например, после 5-10 минут нагрузки.
2. json-дашборды.

**Задание со звездочкой (+5 баллов)**
* Используя существующие системные метрики из кубернетеса, добавить на дашборд графики с метриками:
1. Потребление подами приложения памяти
2. Потребление подами приолжения CPU
* Инструментировать базу данных с помощью экспортера для prometheus для этой БД.
* Добавить в общий дашборд графики с метриками работы БД.

---

## Решение

Для реализации метрик в приложении подключим библиотеку `prometheus-fastapi-instrumentator` и проинициализируем инструментатор `Instrumentator().instrument(app).expose(app)`

**Исходя из того, что у нас "чистый" minikube, нужно сделать следующее:**
* Создаем нужные пространства имен:
```
kubectl create namespace monitoring
kubectl create namespace app
```
* Переходим в папку [infra](infra) где находятся манифесты для разворачивания инфраструктуры
* В пространстве `monitoring` устанавливаем `prometheus-operator` и `nginx-ingress`
```
kubectl config set-context --current --namespace=monitoring
helm install prom stable/prometheus-operator -f prometheus.yaml --atomic
helm install nginx stable/nginx-ingress -f nginx-ingress.yaml --atomic
```
* Возвращаемся в [корневую папку](./)
* В пространстве `app` устанавливаем наше приложение
```
kubectl config set-context --current --namespace=app
helm install otus charts
```

[Скриншот дашборды](otus_app_dashboard.png)

[JSON дашборды](otus_app_montoring-1598533631560.json)


### А также
Для выполнения запроса по домену `arch.homework` нужно добавить запись в `/etc/hosts`. В моём случае получилась запись следующего вида `172.17.0.2 arch.homework`, где `172.17.0.2` - адрес по которому нужно отправлять запросы в миникуб. Узнать его можно командой `minikube ip`.

На одном домене запустить инструменты мониторинга и само приложение не удалось, поэтому для прометея и графаны сделал отдельный домен `monitoring.arch.homework`, который тоже добавил в `/etc/hosts`