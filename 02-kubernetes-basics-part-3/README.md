# Домашнее задание №2
## Тема: Основы работы с Kubernetes (часть 3)

**Задание:**
* Сделать простейший RESTful CRUD по созданию, удалению, просмотру и обновлению пользователей.
* Пример API - https://app.swaggerhub.com/apis/otus55/users/1.0.0

**Требования:**
* Добавить базу данных для приложения.
* Базу данных установить helm-ом из одного из репозиториев чартов (желательно официальных).
* Конфигурация приложения должна хранится в Configmaps.
* Доступы к БД должны храниться в Secrets.
* Первоначальные миграции должны быть оформлены в качестве Job-ы.
* Ingress-ы должны также вести на url arch.homework/otusapp/{student-name}/* (как и в прошлом задании)

**На выходе предоставить:**
1. ссылка на директорию в github, где находится директория с манифестами кубернетеса
2. инструкция по запуску приложения.
- команда установки БД из helm, вместе с файлом values.yaml.
- команда применения первоначальных миграций
- команда kubectl apply -f, которая запускает в правильном порядке манифесты кубернетеса
3. Postman коллекция, в которой будут представлены примеры запросов к сервису на создание, получение, изменение и удаление пользователя.
> Важно: в postman коллекции использовать базовый url - arch.homework.


**Задание со звездочкой:**
* +3 балла за шаблонизацию приложения в helm 3 чартах
* +2 балла за использование официального helm чарта для БД и подключение его в чарт приложения в качестве зависимости.

---

## Решение
Приложение будет развёртываться в **minikube**, на локальной ВМ с ubuntu 18.04 server

В этом задании выкинем flask и реализуем сервис на базе [FastAPI](https://fastapi.tiangolo.com/)
Код сервиса расположен в папке [app](app/) вместе с файлом зависимостей requirements.txt. Наш сервис будет запускаться на порту 8000 и имеет метод `/health/`, возвращающий статус.

Для сборки образа создадим Dockerfile на основе `python:alpine`. Саму сборку выполняем командой `docker build -t drsklifnsk/otus-sa:crud-app-v12 .`

В этот раз используем multistage build для минификации размера образа.
> Перед отправкой образа в dockerhub необходимо в нём авторизоваться командой `docker login`

Отправку образа в dockerhub выполняем командой `'docker push drsklifnsk/otus-sa:crud-app-v12'`

### Инструкция по запуску (kubectl)
> Все необходимые манифесты находятся в папке [manifests](manifests/)
1. `kubectl apply -f secrets.yaml -f config.yaml` - сначала нужны конфиги и секреты
2. `helm install otus bitnami/postgresql -f values.yaml` - установка БД (запускать из папки [charts](charts/))
3. `kubectl apply -f initdb.yaml` - применение миграций
4. `kubectl apply -f ingress.yaml -f deployment.yaml -f service.yaml` - установка манифестов кубернетеса

### Инструкция по запуску (helm)
Установки БД с помощью helm мне показалось недостаточно и я реализовал чарт для приложения со всеми необходимыми ресурсами kubernetes [charts](charts/)

Для развертывания БД используется helm-чарт postgres от bitnami. Добавил его в зависимости чарта нашего приложения.

С помощью helm приложение развертывается из папки [charts](charts/) следующим образом:
```
helm dependencies update
helm install otus .
```

### Postman
Для проверки можно использовать коллекцию Postman [Otus_CRUD_app.postman_collection.json](Otus_CRUD_app.postman_collection.json)

### А также
Для выполнения запроса по домену `'arch.homework'` нужно добавить запись в `'/etc/hosts'`. В моём случае получилась запись следующего вида `'172.17.0.2 arch.homework'`, где `'172.17.0.2'` - адрес по которому нужно отправлять запросы в миникуб. Узнать его можно командой `'minikube ip'`.